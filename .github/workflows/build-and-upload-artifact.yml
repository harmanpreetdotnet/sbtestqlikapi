name: Build and Upload qlik-api Artifact

on:
  push:
    branches:
      - main

env:
  APP_NAME: az-qlikengine-api-repo
  BLOB_FOLDER: switchbladeapps

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # No dependency installation here
      # Azure App Service will build dependencies at deploy time

      - name: Create ZIP artifact (source only)
        run: |
          zip -r "${APP_NAME}.zip" . \
            -x ".git/*" \
               ".github/*" \
               "__pycache__/*" \
               "*.pyc"

      - name: Upload ZIP to Azure Blob Storage
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_CONTAINER: ${{ secrets.AZURE_STORAGE_CONTAINER }}
          AZURE_STORAGE_SAS_RAW: ${{ secrets.AZURE_STORAGE_SAS }}  # may include leading '?'
        run: |
          # Normalize SAS (remove leading '?' if present)
          SAS="${AZURE_STORAGE_SAS_RAW#\?}"

          echo "Uploading artifact to:"
          echo "  Storage account : ${AZURE_STORAGE_ACCOUNT}"
          echo "  Container       : ${AZURE_STORAGE_CONTAINER}"
          echo "  Blob path       : ${BLOB_FOLDER}/${APP_NAME}.zip"

          az storage blob upload \
            --account-name "${AZURE_STORAGE_ACCOUNT}" \
            --container-name "${AZURE_STORAGE_CONTAINER}" \
            --name "${BLOB_FOLDER}/${APP_NAME}.zip" \
            --file "${APP_NAME}.zip" \
            --sas-token "${SAS}" \
            --overwrite true \
            --only-show-errors
